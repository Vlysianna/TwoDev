const [isConfirmOpen, setIsConfirmOpen] = useState(false);
const navigate = useNavigate();

<NavbarAsesi title="Persetujuan Asesmen dan Kerahasiaan" 
icon={ 
<Link to={paths.asesi.dashboard} onClick={(e)=> {
    e.preventDefault(); // cegah auto navigasi
    setIsConfirmOpen(true);
    }}
    className="text-gray-500 hover:text-gray-600"
    >
    <House size={20} />
</Link>
    }
/>

<ConfirmModal isOpen={isConfirmOpen} onClose={()=> setIsConfirmOpen(false)}
        onConfirm={() => {
        setIsConfirmOpen(false);
        navigate(paths.asesi.dashboard); // manual navigate setelah confirm
        }}
        title="Konfirmasi"
        message="Apakah Anda yakin ingin kembali ke Dashboard?"
        confirmText="Ya, kembali"
        cancelText="Batal"
        type="warning"
/>

import { useState, useEffect } from "react";
import { Search, X, AlertCircle, Check } from "lucide-react";
import api from "@/helper/axios";
import { useAuth } from "@/contexts/AuthContext";
import type { AK03Question, AssessmentData } from "@/model/ak03-model";
import { Controller, useForm } from "react-hook-form";
import ConfirmModal from "@/components/ConfirmModal"; // Import ConfirmModal

const defaultQuestions: AK03Question[] = [
// ... (defaultQuestions tetap sama)
];

export default function AK03({
isAssessee,
id_result,
}: {
isAssessee: boolean;
id_result: string;
}) {
const { user } = useAuth();

const [loading, setLoading] = useState(true);
const [errorMessage, setErrorMessage] = useState("");
const [formData, setFormData] = useState<AssessmentData | null>(null);
    const [questions, setQuestions] = useState<AK03Question[]>([]);
        const [filteredData, setFilteredQuestions] = useState<AK03Question[]>([]);
            const [searchTerm, setSearchTerm] = useState("");
            const [filterKompeten, setFilterKompeten] = useState("all");
            const [catatanUmum, setCatatanUmum] = useState("");
            const [showNotif, setShowNotif] = useState(false);
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            const [isSubmitted, setIsSubmitted] = useState(false); // State baru untuk menandai data sudah disimpan

            const {
            control,
            handleSubmit,
            setValue,
            getValues,
            reset,
            formState: { isSubmitting },
            } = useForm({
            defaultValues: {
            answers: defaultQuestions.map((q) => ({
            id: q.id,
            answer: "",
            comment: "",
            })),
            catatanUmum: "",
            },
            });

            useEffect(() => {
            if (user) fetchData();
            }, [user, id_result]);

            const fetchData = async () => {
            try {
            setLoading(true);
            setErrorMessage("");

            const response = await api.get(`/assessments/ak-03/${id_result}`);
            const rawData = response.data;

            if (rawData.success) {
            setFormData(rawData.data);
            const answers =
            rawData.data.result_ak03?.answers?.map((a: AK03Question) => ({
            id: a.id,
            answer: a.answer ? "ya" : "tidak",
            comment: a.comment || "",
            })) ||
            defaultQuestions.map((q) => ({ id: q.id, answer: "", comment: "" }));

            setQuestions(
            rawData.data.result_ak03?.answers.length == 0
            ? defaultQuestions
            : rawData.data.result_ak03?.answers
            );
            setCatatanUmum(rawData.data.result_ak03?.comment || "");
            reset({
            answers,
            catatanUmum: rawData.data.result_ak03?.comment || "",
            });

            // Cek apakah data sudah pernah disimpan
            setIsSubmitted(rawData.data.result_ak03?.answers.length > 0);
            }
            } catch (error: any) {
            setErrorMessage(
            error.response?.data?.message || "Gagal memuat data AK-03"
            );
            } finally {
            setLoading(false);
            }
            };

            // ... (useEffect untuk filteredData tetap sama)

            const prepareSubmitData = (data: any) => {
            return {
            result_id: parseInt(id_result),
            comment: data.catatanUmum.trim() || "-",
            items: data.answers.map((a: any, i: number) => ({
            question: questions[i].question,
            answer: a.answer === "ya",
            comment: a.comment.trim() || "-",
            })),
            };
            };

            const onSubmit = async (data: any) => {
            if (!isAssessee || isSubmitted) return; // Jangan izinkan submit jika sudah disimpan

            // Validasi apakah semua pertanyaan sudah dijawab
            const hasUnanswered = data.answers.some((a: any) => !a.answer);
            if (hasUnanswered) {
            setErrorMessage("Harap jawab semua pertanyaan sebelum menyimpan");
            return;
            }

            setShowConfirmModal(true);
            };

            const handleConfirmSubmit = async () => {
            try {
            const data = getValues();
            const payload = prepareSubmitData(data);

            const response = await api.post("/assessments/ak-03/answer", payload);
            if (!response.data.success) {
            setErrorMessage(response.data.message || "Gagal menyimpan data.");
            } else {
            setShowNotif(true);
            setIsSubmitted(true); // Set state bahwa data sudah disimpan
            setTimeout(() => setShowNotif(false), 2500);
            }
            } catch (error: any) {
            setErrorMessage(error.response?.data?.message || "Gagal menyimpan data.");
            } finally {
            setShowConfirmModal(false);
            }
            };

            const handleFilterChange = (value: string) => {
            if (!isAssessee || isSubmitted) return; // Jangan izinkan perubahan jika sudah disimpan
            setFilterKompeten(value);
            if (value === "ya" || value === "tidak") {
            questions.forEach((_q, idx) => setValue(`answers.${idx}.answer`, value));
            }
            };

            // ... (loading dan error handling tetap sama)

            return (
            <div className="">
                {/* Notifikasi Simpan */}
                {showNotif && (
                <div
                    className="fixed top-6 right-6 z-50 bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded shadow flex items-center animate-fade-in">
                    <Check size={20} className="mr-2" />
                    Data berhasil disimpan!
                </div>
                )}

                {/* Modal Konfirmasi dengan ConfirmModal */}
                <ConfirmModal isOpen={showConfirmModal} onClose={()=> setShowConfirmModal(false)}
                    onConfirm={handleConfirmSubmit}
                    title="Konfirmasi Simpan"
                    message="Apakah Anda yakin ingin menyimpan data ini?"
                    confirmText="Ya, Simpan"
                    cancelText="Batal"
                    type="warning"
                    />

                    {/* ... (error message dan form UI tetap sama) */}

                    <form onSubmit={handleSubmit(onSubmit)}>
                        {/* Table */}
                        <div className="w-full overflow-x-auto border border-gray-200 rounded-sm">
                            <div className="max-h-96 overflow-y-auto">
                                <table className="w-full min-w-[600px] lg:min-w-[800px] table-auto border-collapse">
                                    <thead className="bg-gray-50 sticky top-0 z-10">
                                        <tr>
                                            {/* ... (table headers tetap sama) */}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredData.map((item, idx) => (
                                        <tr key={item.id} className="border-t border-gray-200">
                                            {/* ... (table cells tetap sama) */}
                                            <td className="px-2 py-2 text-center">
                                                <div
                                                    className="flex flex-col sm:flex-row items-start sm:items-center justify-center gap-2 sm:gap-4">
                                                    {/* Radio Ya/Tidak */}
                                                    <Controller control={control} name={`answers.${idx}.answer`}
                                                        render={({ field })=> (
                                                        <>
                                                            {["Ya", "Tidak"].map((val) => (
                                                            <label className={`flex items-center gap-2 px-2 py-1
                                                                rounded-sm cursor-pointer transition text-xs sm:text-sm
                                                                ${!isAssessee || isSubmitted
                                                                ? "text-gray-400 cursor-not-allowed"
                                                                : "text-gray-700 cursor-pointer" }
                                                                ${field.value===val.toLowerCase() ? "bg-[#E77D3533]"
                                                                : "" }`} key={val.toLowerCase()}>
                                                                <input type="radio" value={val.toLowerCase()} checked={
                                                                    field.value===val.toLowerCase() } onChange={()=>
                                                                (isAssessee && !isSubmitted) &&
                                                                field.onChange(val.toLowerCase())
                                                                }
                                                                className="hidden"
                                                                disabled={!isAssessee || isSubmitted}
                                                                />
                                                                <span className={`w-4 h-4 flex items-center
                                                                    justify-center rounded-full border-2 ${(!isAssessee
                                                                    || isSubmitted) && "cursor-not-allowed" }
                                                                    ${field.value===val.toLowerCase()
                                                                    ? "bg-[#E77D35] border-[#E77D35]"
                                                                    : "border-[#E77D35]" }`}>
                                                                    {field.value === val.toLowerCase() && (
                                                                    <Check className="w-4 h-4 text-white" />
                                                                    )}
                                                                </span>
                                                                <span className={ field.value===val.toLowerCase()
                                                                    ? "text-gray-900" : "text-gray-500" }>
                                                                    {val}
                                                                </span>
                                                            </label>
                                                            ))}
                                                        </>
                                                        )}
                                                        />
                                                </div>
                                            </td>
                                            <td className="px-2 py-2">
                                                <Controller control={control} name={`answers.${idx}.comment`} render={({
                                                    field })=> (
                                                    <textarea className={`w-full px-3 py-2 border border-gray-300
                                                        rounded focus:outline-none focus:ring-2 focus:ring-blue-500
                                                        text-xs sm:text-sm ${!isAssessee || isSubmitted
                                                        ? "cursor-not-allowed bg-gray-100" : "" }`} {...field}
                                                        placeholder="Masukkan catatan..." rows={3} disabled={!isAssessee
                                                        || isSubmitted} />
                                                    )}
                                                    />
                                            </td>
                                        </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="mt-6">
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                Catatan/komentar lainnya (apabila ada) :
                            </label>

                            <Controller control={control} name="catatanUmum" render={({ field })=> (
                                <textarea className={`w-full px-3 py-2 border border-gray-300 rounded-md
                                    focus:outline-none focus:ring-2 focus:ring-[#E77D35] text-sm ${!isAssessee ||
                                    isSubmitted ? "cursor-not-allowed bg-gray-100" : "" }`} placeholder="Catatan"
                                    rows={4} {...field} disabled={!isAssessee || isSubmitted} />
                                )}
                                />

                                {isAssessee && (
                                <div className="flex flex-col sm:flex-row justify-end gap-3 mt-4 w-full">
                                    <button type="submit" disabled={loading || isSubmitting || isSubmitted}
                                        className="w-full sm:w-auto px-30 py-2 bg-[#E77D35] text-sm text-white rounded hover:bg-orange-600 transition cursor-pointer disabled:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed">
                                        {isSubmitting ? "Menyimpan..." : isSubmitted ? "Tersimpan" : "Simpan"}
                                    </button>
                                </div>
                                )}
                        </div>
                    </form>
            </div>
            );
            }